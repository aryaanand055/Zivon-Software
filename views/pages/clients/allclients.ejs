<section class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">All Clients</h2>
    <a href="/clients/add" class="btn btn-primary d-flex align-items-center gap-1 shadow-sm">
      <i class="bi bi-person-plus-fill"></i> Add Client
    </a>
  </div>

  <% if (clients && clients.length > 0) { %>
  <div class="table-responsive shadow-sm rounded-3 border border-light-subtle">
    <table class="table table-hover align-middle text-nowrap">
      <thead class="table-dark text-center">
        <tr>
          <th>Member ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>DOB</th>
          <th>Medical</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% clients.forEach(function(client) { %>
        <tr class="client-row transition-fade" onclick="window.location.href='/clients/view/<%= client.memberID %>'" style="cursor: pointer;">
          <td><%= client.memberID %></td>
          <td><%= client.name %></td>
          <td><%- client.email %></td>
          <td><%= client.mobile %></td>
          <td><%= new Date(client.dob).toLocaleDateString('en-GB') %></td>
          <td><%= client.medicalHistory || "None" %></td>
          <td class="text-center">
            <div class="d-flex flex-wrap justify-content-center gap-2">
              <a href="/clients/edit/<%= client.memberID %>" class="btn btn-outline-warning btn-sm px-3" title="Edit Client" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Edit Client">
                <i class="bi bi-pencil"></i>
              </a>
              <button class="btn btn-outline-danger btn-sm px-3 delete-user-btn" title="Delete Client" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete Client">
                <i class="bi bi-trash"></i>
              </button>
              <a href="/clients/subscribe/<%= client.memberID %>" class="btn btn-outline-primary btn-sm px-3" title="Add Subscription" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Add Subscription">
                <i class="bi bi-card-checklist"></i>
              </a>
            </div>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
  <% } else { %>
  <div class="alert alert-secondary text-center">
    No members found. <a href="/add-client" class="text-decoration-underline">Add a new client</a>.
  </div>
  <% } %>
</section>

<style>
  .transition-fade {
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  .fade-out {
    opacity: 0;
    transform: scale(0.95);
  }
</style>

<script>
  const deleteBtns = document.querySelectorAll('.delete-user-btn');

  deleteBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();

      const row = this.closest('tr');
      const memberId = row.querySelector('td').innerText;

      if (confirm(`Are you sure you want to delete client with Member ID: ${memberId}? This will also delete all their subscriptions.`)) {
        fetch(`/clients/delete/${memberId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              row.classList.add('fade-out');
              setTimeout(() => row.remove(), 500);
              alert(data.message);
            } else {
              alert(data.message);
            }
          })
          .catch(err => {
            alert("Something went wrong while deleting the client.");
            console.error(err);
          });
      }
    });
  });
</script>